<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Segurança</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="index.css">
</head>
<body>

    <div id="notification-container"></div>
    <div class="overlay"></div>
    
    <button id="menu-toggle-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>

    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="assets/mono-pbMarca-Belfort-Engenharia.png" alt="Logo Belfort Engenharia" class="logo-light">
                <img src="assets/mono-brancaMarca-Belfort-Engenharia (1).png" alt="Logo Belfort Engenharia" class="logo-dark">
            </div>
            <nav class="sidebar-nav">
                <a href="#" class="active" onclick="showPage('fichas_epi')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
                    Ficha de EPI
                </a>
                <a href="#" onclick="showPage('obras')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg> Obras
                </a>
                <a href="#" onclick="showPage('documentos')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg> Documentos
                </a>
                <a href="#" onclick="showPage('notificacoes')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg> Notificações
                </a>
                <a href="#" onclick="showPage('controles')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg> Controles
                </a>
            </nav>
            <div class="theme-toggle-container">
                <svg class="theme-icon icon-sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                <button id="btn-dark-mode-toggle"></button>
                <svg class="theme-icon icon-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </div>
        </aside>

        <main class="content">
            <div id="fichas_epi-page" class="page-content active">
                <div class="card">
                    <h2 id="ficha-epi-form-title">Ficha de EPI</h2>
                    <div class="form-group"> <label for="nome-colaborador">Nome do Colaborador</label> <input type="text" id="nome-colaborador"> </div>
                    
                    <div id="epi-list-container">
                        </div>

                    <div class="btn-group"> <button id="btn-salvar-ficha-epi" onclick="salvarFichaEpi()">Cadastrar Ficha</button> <button class="btn-secondary" onclick="toggleView('FichasEPI')">Ver Fichas Cadastradas</button> </div>
                    <div id="fichas_epi-view-container" class="view-container" style="display:none;">
                        <div class="search-bar form-group">
                            <label for="busca-ficha-epi">Buscar por Colaborador</label>
                            <input type="text" id="busca-ficha-epi" onkeyup="atualizarVisualizacao('FichasEPI')" placeholder="Digite o nome para filtrar...">
                        </div>
                        <div id="fichas_epi-cadastradas-view" class="cadastros-view"></div>
                    </div>
                </div>
            </div>

            <div id="obras-page" class="page-content">
                 <div class="card">
                    <h2 id="obra-form-title">Cadastro de Obra</h2>
                    <div class="form-group"> <label for="desc-obra">Descrição da Obra</label> <input type="text" id="desc-obra"> </div>
                    <div class="form-group"> <label for="data-entrega-obra">Data da entrega da obra</label> <input type="date" id="data-entrega-obra"> </div>
                    <div class="form-group"> <label for="data-manutencao">Próxima manutenção</label> <input type="date" id="data-manutencao"> </div>
                    <div class="btn-group"> <button id="btn-salvar-obra" onclick="salvarObra()">Cadastrar Obra</button> <button class="btn-secondary" onclick="toggleView('Obras')">Ver Cadastradas</button> </div>
                    <div id="obras-view-container" class="view-container" style="display:none;">
                        <div class="search-bar form-group">
                            <label for="busca-obras">Buscar Obra</label>
                            <input type="text" id="busca-obras" onkeyup="atualizarVisualizacao('Obras')" placeholder="Digite a descrição para filtrar...">
                        </div>
                        <div id="obras-cadastradas-view" class="cadastros-view"></div>
                    </div>
                </div>
            </div>
            <div id="documentos-page" class="page-content">
                <div class="card">
                    <h2>Atualizar Documentos da Obra</h2>
                    <div class="form-group">
                        <label for="doc-select-obra">Selecione a Obra para atualizar</label>
                        <select id="doc-select-obra" onchange="carregarDetalhesDaObra()">
                            <option value="" disabled selected>Selecione uma obra...</option>
                        </select>
                    </div>
                    <div class="document-grid">
                        <div class="checkbox-group"> <input type="checkbox" id="art-rrt-recebida"> <label for="art-rrt-recebida">ART / RRT Recebida</label> </div>
                        <div class="checkbox-group"> <input type="checkbox" id="alvara-emitido"> <label for="alvara-emitido">Alvará de Construção Emitido</label> </div>
                        <div class="checkbox-group"> <input type="checkbox" id="avcb-aprovado"> <label for="avcb-aprovado">AVCB / Bombeiros Aprovado</label> </div>
                        <div class="checkbox-group"> <input type="checkbox" id="habitese-emitido"> <label for="habitese-emitido">Habite-se Emitido</label> </div>
                        <div class="checkbox-group"> <input type="checkbox" id="nf-recebida"> <label for="nf-recebida">Nota Fiscal Recebida</label> </div>
                    </div>
                    <div class="form-group">
                        <label>Anexar Arquivos</label>
                        <div id="drop-zone">
                            <input type="file" id="file-input" multiple hidden accept=".png,.jpeg,.jpg,.pdf,.docx">
                            <div class="drop-zone-text">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                                <p>Arraste e solte os arquivos aqui</p>
                                <button type="button" class="btn-upload">Selecionar Arquivos</button>
                                <span>PNG, JPG, PDF, DOCX</span>
                            </div>
                        </div>
                        <div id="file-list"></div>
                    </div>
                    <div class="btn-group"> <button id="btn-atualizar-docs" onclick="marcarEnvioDocumentos()">Atualizar Documentos</button> </div>
                </div>
            </div>
            <div id="notificacoes-page" class="page-content">
                <div class="card">
                    <h2 class="notifications-header">Itens Datados</h2>
                    <div class="notifications-columns">
                        <div class="notification-column">
                            <h3 class="column-title">Fichas de EPI</h3>
                            <div id="epi-notifications-list" class="item-list"></div>
                        </div>
                        <div class="notification-column">
                            <h3 class="column-title">Obras</h3>
                            <div id="obras-notifications-list" class="item-list"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="controles-page" class="page-content">
                <div class="card">
                    <h2>Controles Gerais</h2>
                    <p>Aqui você pode gerenciar os dados do sistema e verificar alertas.</p>
                    <div class="btn-group">
                        <button onclick="mostrarAlertas()">Verificar Alertas</button>
                        <button class="btn-reset" onclick="resetarDados()">Resetar Todos os Dados</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="notification-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Opções de Notificação</h3>
                <button class="close-button" onclick="fecharModalNotificacao()">&times;</button>
            </div>
            <div class="modal-body">
                <p><strong>Item:</strong> <span id="modal-item-descricao"></span></p>
                <p><strong>Vencimento:</strong> <span id="modal-item-data"></span></p>
            </div>
            <div class="modal-actions">
                <button id="modal-btn-email">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                    Email
                </button>
                <button id="modal-btn-whatsapp">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                    WhatsApp
                </button>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, getDoc, doc, updateDoc, deleteDoc, orderBy, query, writeBatch } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC1jdjj2mQ9IhSCk3wRilqimNA_zLvaOs8",
      authDomain: "gerenciador-2ponto0.firebaseapp.com",
      projectId: "gerenciador-2ponto0",
      storageBucket: "gerenciador-2ponto0.appspot.com",
      messagingSenderId: "852746372282",
      appId: "1:852746372282:web:b8bff69130c39e40782e83",
      measurementId: "G-DTH247GZDW"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const ARQUIVO_FICHA_EPI = "fichas_epi";
    const ARQUIVO_OBRA = "obras";
    let modoEdicao = { ativo: false, tipo: null, id: null };
    let itemNotificacaoAtual = null;
    let newFiles = [];
    let existingFiles = [];
    
    const CLOUDINARY_CLOUD_NAME = "SEU_CLOUD_NAME_AQUI"; 
    const CLOUDINARY_UPLOAD_PRESET = "SEU_UPLOAD_PRESET_AQUI";

    function showNotification(message, type = 'info') {
        const container = document.getElementById('notification-container');
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        container.appendChild(notification);
        setTimeout(() => notification.remove(), 5000);
    }

    function formatarDataParaSalvar(dataString) {
        if (!dataString) return "";
        const [ano, mes, dia] = dataString.split('-');
        return `${dia}/${mes}/${ano}`;
    }

    function formatarDataParaInput(dataString) {
        if (!dataString || !dataString.includes('/')) return "";
        const [dia, mes, ano] = dataString.split('/');
        return `${ano}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
    }

    function getInput(id) { return document.getElementById(id); }

    async function excluirItem(tipo, id, descricao) {
        let collectionName, nomeItem;
        switch(tipo) {
            case 'FichasEPI': collectionName = ARQUIVO_FICHA_EPI; nomeItem = 'Ficha de EPI'; break;
            case 'Obras': collectionName = ARQUIVO_OBRA; nomeItem = 'Obra'; break;
        }
        
        if (confirm(`Tem certeza que deseja excluir ${nomeItem}: "${descricao}"?`)) {
            try {
                await deleteDoc(doc(db, collectionName, id));
                showNotification(`${nomeItem} excluído com sucesso!`, 'success');
                atualizarVisualizacao(tipo);
            } catch (error) {
                showNotification(`Erro ao excluir o ${nomeItem}.`, 'error');
            }
        }
    }
    
    async function salvarFichaEpi() {
        try {
            const nomeColaborador = getInput('nome-colaborador').value.trim();
            if (!nomeColaborador) throw new Error("O nome do colaborador é obrigatório.");

            const episSelecionados = {};
            const epiCheckboxes = document.querySelectorAll('#epi-list-container .checkbox-group input[type="checkbox"]:checked');
            
            if (epiCheckboxes.length === 0) throw new Error("Selecione ao menos um EPI para o colaborador.");

            for (const checkbox of epiCheckboxes) {
                const epiId = checkbox.id.replace('check-', '');
                const epiDataContainer = getInput(`data-${epiId}`);
                
                const data_entrega = epiDataContainer.querySelector(`#entrega-${epiId}`).value;
                const tempo_troca_dias = parseInt(epiDataContainer.querySelector(`#tempo-${epiId}`).value, 10);
                const data_troca = epiDataContainer.querySelector(`#troca-${epiId}`).value;
                const justificativa = epiDataContainer.querySelector(`#justificativa-${epiId}`).value.trim();

                if (!data_entrega || isNaN(tempo_troca_dias)) {
                    throw new Error(`Preencha a data de entrega e o tempo de troca para o EPI: ${checkbox.dataset.nome}`);
                }

                episSelecionados[checkbox.dataset.nome] = {
                    data_entrega: formatarDataParaSalvar(data_entrega),
                    tempo_troca_dias,
                    data_troca: formatarDataParaSalvar(data_troca),
                    justificativa
                };
            }

            const ficha = {
                colaborador: nomeColaborador,
                epis: episSelecionados,
                timestamp: new Date() 
            };
            
            const collectionRef = collection(db, ARQUIVO_FICHA_EPI);
            if (modoEdicao.ativo && modoEdicao.tipo === 'FichasEPI') {
                await updateDoc(doc(db, ARQUIVO_FICHA_EPI, modoEdicao.id), ficha);
                showNotification("Ficha de EPI atualizada com sucesso!", 'success');
            } else {
                await addDoc(collectionRef, ficha);
                showNotification("Ficha de EPI cadastrada com sucesso!", 'success');
            }
            
            resetarFormulario('FichasEPI');
            atualizarVisualizacao('FichasEPI');
        } catch (e) {
            showNotification(`Erro: ${e.message}`, 'error');
        }
    }

    async function salvarObra() {
        try {
            const obraData = {
                descricao: getInput('desc-obra').value.trim(),
                data_entrega_obra: formatarDataParaSalvar(getInput('data-entrega-obra').value),
                data_proxima_manutencao: formatarDataParaSalvar(getInput('data-manutencao').value),
            };
            if (!obraData.descricao || !obraData.data_entrega_obra || !obraData.data_proxima_manutencao) throw new Error("Preencha todos os campos da Obra.");

            const collectionRef = collection(db, ARQUIVO_OBRA);
            if (modoEdicao.ativo && modoEdicao.tipo === 'Obras') {
                const docRef = doc(db, ARQUIVO_OBRA, modoEdicao.id);
                await updateDoc(docRef, obraData);
                showNotification("Obra atualizada!", 'success');
            } else {
                Object.assign(obraData, {
                    doc_art_rrt: false, doc_alvara: false, doc_avcb: false, doc_habitese: false, doc_nf: false, anexos: []
                });
                await addDoc(collectionRef, obraData);
                showNotification("Obra cadastrada!", 'success');
            }
            resetarFormulario('Obras');
            atualizarVisualizacao('Obras');
        } catch (e) {
            showNotification(`Erro: ${e.message}`, 'error');
        }
    }

    async function editarItem(tipo, id) {
        let pageId, collectionName;
        switch(tipo) {
            case 'FichasEPI': pageId = 'fichas_epi'; collectionName = ARQUIVO_FICHA_EPI; break;
            case 'Obras': pageId = 'obras'; collectionName = ARQUIVO_OBRA; break;
        }
        
        const docRef = doc(db, collectionName, id);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) return;
        
        const item = docSnap.data();
        modoEdicao = { ativo: true, tipo, id };
        
        showPage(pageId);
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        if (tipo === 'FichasEPI') {
            getInput('nome-colaborador').value = item.colaborador;
            
            Object.keys(item.epis).forEach(nomeEpi => {
                const epiData = item.epis[nomeEpi];
                const epiId = nomeEpi.replace(/\s+/g, '-').toLowerCase();
                const checkbox = getInput(`check-${epiId}`);
                if (checkbox) {
                    checkbox.checked = true;
                    toggleEpiData(checkbox);
                    
                    const epiDataContainer = getInput(`data-${epiId}`);
                    epiDataContainer.querySelector(`#entrega-${epiId}`).value = formatarDataParaInput(epiData.data_entrega);
                    epiDataContainer.querySelector(`#tempo-${epiId}`).value = epiData.tempo_troca_dias;
                    epiDataContainer.querySelector(`#troca-${epiId}`).value = formatarDataParaInput(epiData.data_troca);
                    epiDataContainer.querySelector(`#justificativa-${epiId}`).value = epiData.justificativa || "";
                }
            });

            getInput('ficha-epi-form-title').textContent = "Editando Ficha de EPI";
            getInput('btn-salvar-ficha-epi').textContent = "Salvar Alterações";
        } else {
            getInput('desc-obra').value = item.descricao;
            getInput('data-entrega-obra').value = formatarDataParaInput(item.data_entrega_obra);
            getInput('data-manutencao').value = formatarDataParaInput(item.data_proxima_manutencao);
            getInput('obra-form-title').textContent = "Editando Obra";
            getInput('btn-salvar-obra').textContent = "Salvar Alterações";
        }
    }
    
    function resetarFormulario(tipo) {
        modoEdicao = { ativo: false, tipo: null, id: null };
        if (tipo === 'FichasEPI') {
            getInput('nome-colaborador').value = '';
            document.querySelectorAll('#epi-list-container .checkbox-group input').forEach(c => c.checked = false);
            document.querySelectorAll('.epi-data-container').forEach(d => d.style.display = 'none');
            getInput('ficha-epi-form-title').textContent = "Ficha de EPI";
            getInput('btn-salvar-ficha-epi').textContent = "Cadastrar Ficha";
        } else if (tipo === 'Obras') {
            ['desc-obra', 'data-entrega-obra', 'data-manutencao'].forEach(id => getInput(id).value = '');
            getInput('obra-form-title').textContent = "Cadastro de Obra";
            getInput('btn-salvar-obra').textContent = "Cadastrar Obra";
        } else if (tipo === 'Documentos') {
            getInput('doc-select-obra').value = "";
            ['art-rrt-recebida', 'alvara-emitido', 'avcb-aprovado', 'habitese-emitido', 'nf-recebida'].forEach(id => getInput(id).checked = false);
            newFiles = [];
            existingFiles = [];
            renderFileList();
        }
    }

    function toggleView(tipo) {
        const containerId = `${tipo.toLowerCase().replace('fichasepi', 'fichas_epi')}-view-container`;
        const container = getInput(containerId);
        container.style.display = container.style.display === 'block' ? 'none' : 'block';
        if (container.style.display === 'block') {
            atualizarVisualizacao(tipo);
        }
    }

    async function atualizarVisualizacao(tipo) {
        let collectionName, viewId, buscaId;
        switch(tipo) {
            case 'FichasEPI': 
                collectionName = ARQUIVO_FICHA_EPI; 
                viewId = 'fichas_epi-cadastradas-view'; 
                buscaId = 'busca-ficha-epi'; 
                break;
            case 'Obras': 
                collectionName = ARQUIVO_OBRA; 
                viewId = 'obras-cadastradas-view'; 
                buscaId = 'busca-obras'; 
                break;
        }
        
        const viewElement = getInput(viewId);
        const termoBusca = getInput(buscaId).value.toLowerCase();
        viewElement.innerHTML = '<p style="text-align: center;">Carregando...</p>';

        try {
            const q = query(collection(db, collectionName), orderBy(tipo === 'FichasEPI' ? 'colaborador' : 'descricao'));
            const snapshot = await getDocs(q);
            const dados = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            const dadosFiltrados = dados.filter(item => {
                if (!termoBusca) return true;
                return (item.colaborador || item.descricao).toLowerCase().includes(termoBusca);
            });

            viewElement.innerHTML = '';
            if (dadosFiltrados.length === 0) {
                viewElement.innerHTML = `<p style="text-align: center;">Nenhum item encontrado.</p>`;
                return;
            }

            dadosFiltrados.forEach(item => {
                const itemContainer = document.createElement('div');
                itemContainer.className = 'item-cadastrado';
                let bodyContent = '', headerText = item.colaborador || item.descricao;

                if (tipo === 'FichasEPI') {
                    bodyContent += '<div class="epi-details-grid">';
                    for (const nomeEpi in item.epis) {
                        const epi = item.epis[nomeEpi];
                        bodyContent += `
                            <div class="epi-detail-item">
                                <strong>${nomeEpi}</strong>
                                <p>Entrega: ${epi.data_entrega}</p>
                                <p>Dias p/ Troca: ${epi.tempo_troca_dias}</p>
                                <p>Próxima Troca: ${epi.data_troca}</p>
                                ${epi.justificativa ? `<p>Justificativa: ${epi.justificativa}</p>` : ''}
                            </div>
                        `;
                    }
                    bodyContent += '</div>';
                } else if (tipo === 'Obras') {
                    bodyContent += `<p><strong>Data entrega obra:</strong> ${item.data_entrega_obra || 'N/A'}</p>`;
                    bodyContent += `<p><strong>Próxima manutenção:</strong> ${item.data_proxima_manutencao || 'N/A'}</p>`;
                    const statusDocsHtml = `
                        <div class="documentos-view">
                            <strong>Status dos Documentos:</strong>
                            <p>ART / RRT Recebida: <span>${item.doc_art_rrt ? 'Sim' : 'Não'}</span></p>
                            <p>Alvará de Construção Emitido: <span>${item.doc_alvara ? 'Sim' : 'Não'}</span></p>
                            <p>AVCB / Bombeiros Aprovado: <span>${item.doc_avcb ? 'Sim' : 'Não'}</span></p>
                            <p>Habite-se Emitido: <span>${item.doc_habitese ? 'Sim' : 'Não'}</span></p>
                            <p>Nota Fiscal Recebida: <span>${item.doc_nf ? 'Sim' : 'Não'}</span></p>
                        </div>
                    `;
                    bodyContent += statusDocsHtml;
                    if (item.anexos && item.anexos.length > 0) {
                        const linksAnexos = item.anexos.map(anexo => `<li><a href="${anexo.url}" target="_blank">${anexo.name}</a></li>`).join('');
                        bodyContent += `<div class="anexos-view"><strong>Arquivos Anexados:</strong><ul>${linksAnexos}</ul></div>`;
                    }
                }
                
                itemContainer.innerHTML = `
                    <div class="item-header">
                        <h4>${headerText}</h4>
                        <div class="item-actions">
                             <button class="btn-notify" title="Notificar"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg></button>
                            <button class="btn-edit" title="Editar"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                            <button class="btn-delete" title="Excluir"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                        </div>
                    </div>
                    <div class="item-body">${bodyContent}</div>`;

                itemContainer.querySelector('.btn-notify').addEventListener('click', () => abrirModalNotificacao(tipo, item.id));
                itemContainer.querySelector('.btn-edit').addEventListener('click', () => editarItem(tipo, item.id));
                itemContainer.querySelector('.btn-delete').addEventListener('click', () => excluirItem(tipo, item.id, headerText));
                viewElement.appendChild(itemContainer);
            });
        } catch (error) {
            console.error("Erro ao atualizar visualização:", error);
            viewElement.innerHTML = `<p style="text-align: center; color: var(--cor-erro);">Erro ao carregar dados.</p>`;
        }
    }

    async function marcarEnvioDocumentos() {
        const obraSelecionadaId = getInput('doc-select-obra').value;
        if (!obraSelecionadaId) {
            showNotification("Por favor, selecione uma obra válida.", "warning");
            return;
        }

        const btn = getInput('btn-atualizar-docs');
        btn.disabled = true;
        btn.textContent = 'Atualizando...';

        try {
            const uploadPromises = newFiles.map(async (file) => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) throw new Error(`Falha no upload do arquivo: ${file.name}`);
                const data = await response.json();
                return { name: file.name, url: data.secure_url };
            });
            
            const novosAnexos = await Promise.all(uploadPromises);
            const todosAnexos = [...existingFiles, ...novosAnexos];

            const obraRef = doc(db, ARQUIVO_OBRA, obraSelecionadaId);
            await updateDoc(obraRef, {
                doc_art_rrt: getInput('art-rrt-recebida').checked,
                doc_alvara: getInput('alvara-emitido').checked,
                doc_avcb: getInput('avcb-aprovado').checked,
                doc_habitese: getInput('habitese-emitido').checked,
                doc_nf: getInput('nf-recebida').checked,
                anexos: todosAnexos
            });

            showNotification("Documentos da obra atualizados com sucesso!", "success");
            resetarFormulario('Documentos');
            await popularListaObras();

        } catch (error) {
            console.error("Erro detalhado ao atualizar documentos:", error);
            showNotification(`Erro ao atualizar: ${error.message}`, "error");
        } finally {
            btn.disabled = false;
            btn.textContent = 'Atualizar Documentos';
        }
    }

    async function popularListaObras() {
        const select = getInput('doc-select-obra');
        const currentValue = select.value;
        select.innerHTML = '<option value="" disabled selected>Selecione uma obra...</option>';
        
        const q = query(collection(db, ARQUIVO_OBRA), orderBy("descricao"));
        const snapshot = await getDocs(q);
        snapshot.docs.forEach(doc => {
            const option = document.createElement('option');
            option.value = doc.id;
            option.textContent = doc.data().descricao;
            select.appendChild(option);
        });
        select.value = currentValue;
    }

    async function carregarDetalhesDaObra() {
        const obraSelecionadaId = getInput('doc-select-obra').value;

        existingFiles = [];
        newFiles = [];
        renderFileList();

        if (!obraSelecionadaId) {
            resetarFormulario('Documentos');
            return;
        }

        try {
            const docRef = doc(db, ARQUIVO_OBRA, obraSelecionadaId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                getInput('art-rrt-recebida').checked = data.doc_art_rrt || false;
                getInput('alvara-emitido').checked = data.doc_alvara || false;
                getInput('avcb-aprovado').checked = data.doc_avcb || false;
                getInput('habitese-emitido').checked = data.doc_habitese || false;
                getInput('nf-recebida').checked = data.doc_nf || false;
                
                existingFiles = data.anexos || [];
                renderFileList();
            }
        } catch (error) {
            console.error("Erro ao carregar detalhes da obra:", error);
            showNotification("Erro ao carregar os detalhes da obra.", "error");
        }
    }

    function toggleDarkMode() {
        document.body.classList.toggle('dark-theme');
        localStorage.setItem('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
    }
    
    function showPage(pageId) {
        document.querySelectorAll('.page-content.active, .sidebar-nav a.active').forEach(el => el.classList.remove('active'));
        getInput(pageId + '-page').classList.add('active');
        document.querySelector(`.sidebar-nav a[onclick*="'${pageId}'"]`).classList.add('active');
        
        resetarFormulario('FichasEPI');
        resetarFormulario('Obras');
        resetarFormulario('Documentos');

        if (pageId === 'documentos') popularListaObras();
        if (pageId === 'notificacoes') carregarNotificacoes();

        const sidebar = document.querySelector('.sidebar');
        if (sidebar.classList.contains('open')) {
            sidebar.classList.remove('open');
            document.querySelector('.overlay').classList.remove('active');
        }
    }

    async function carregarNotificacoes() {
        const epiList = document.getElementById('epi-notifications-list');
        const obraList = document.getElementById('obras-notifications-list');
        epiList.innerHTML = '<p>Carregando...</p>';
        obraList.innerHTML = '<p>Carregando...</p>';

        try {
            const fichaQuery = query(collection(db, ARQUIVO_FICHA_EPI), orderBy("colaborador"));
            const fichaSnapshot = await getDocs(fichaQuery);
            const fichas = fichaSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            epiList.innerHTML = '';
            if (fichas.length > 0) {
                fichas.forEach(item => {
                    for (const nomeEpi in item.epis) {
                        const epiData = item.epis[nomeEpi];
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'notification-item';
                        itemDiv.innerHTML = `<p><strong>${item.colaborador} - ${nomeEpi}</strong></p><p>Próxima troca em: ${epiData.data_troca}</p>`;
                        itemDiv.onclick = () => editarItem('FichasEPI', item.id);
                        epiList.appendChild(itemDiv);
                    }
                });
            } else {
                epiList.innerHTML = '<p>Nenhuma Ficha de EPI cadastrada.</p>';
            }

            const obraQuery = query(collection(db, ARQUIVO_OBRA), orderBy("descricao"));
            const obraSnapshot = await getDocs(obraQuery);
            const obras = obraSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            obraList.innerHTML = '';
            if (obras.length > 0) {
                obras.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'notification-item';
                    itemDiv.innerHTML = `<p><strong>${item.descricao}</strong></p><p>Próxima manutenção em: ${item.data_proxima_manutencao}</p>`;
                    itemDiv.onclick = () => editarItem('Obras', item.id);
                    obraList.appendChild(itemDiv);
                });
            } else {
                obraList.innerHTML = '<p>Nenhuma obra cadastrada.</p>';
            }
        } catch (error) {
            epiList.innerHTML = '<p style="color: var(--cor-erro)">Falha ao carregar Fichas de EPI.</p>';
            obraList.innerHTML = '<p style="color: var(--cor-erro)">Falha ao carregar obras.</p>';
        }
    }

    async function abrirModalNotificacao(tipo, id) {
        let collectionName, item, descricao, dataVencimento;
        const docRef = doc(db, tipo === 'Obras' ? ARQUIVO_OBRA : ARQUIVO_FICHA_EPI, id);
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) return showNotification("Item não encontrado.", "error");
        
        item = docSnap.data();
        descricao = item.descricao || item.colaborador; 
        dataVencimento = item.data_proxima_manutencao || "N/A (Verificar EPIs)";

        getInput('modal-item-descricao').textContent = descricao;
        getInput('modal-item-data').textContent = dataVencimento;

        getInput('modal-btn-email').onclick = () => {
            const subject = `Lembrete de Vencimento: ${descricao}`;
            const details = `Lembrete para o item: ${descricao}\nData de Vencimento: ${dataVencimento}`;
            enviarConfirmacaoPorEmail(subject, details);
            fecharModalNotificacao();
        };

        getInput('modal-btn-whatsapp').onclick = () => {
            enviarNotificacaoWhatsApp(descricao, dataVencimento);
            fecharModalNotificacao();
        };

        getInput('notification-modal').classList.add('open');
    }

    function fecharModalNotificacao() {
        getInput('notification-modal').classList.remove('open');
        itemNotificacaoAtual = null;
    }

    function enviarNotificacaoWhatsApp(descricao, dataVencimento) {
        const numero = '5598992220706';
        const mensagem = `Lembrete de Vencimento:\n\nItem: *${descricao}*\nVencimento: *${dataVencimento}*`;
        const url = `https://wa.me/${numero}?text=${encodeURIComponent(mensagem)}`;
        window.open(url, '_blank');
    }
    
    function setupFileUpload() {
        const dropZone = getInput('drop-zone');
        const fileInput = getInput('file-input');
        const uploadButton = dropZone.querySelector('.btn-upload');

        dropZone.addEventListener('click', () => fileInput.click());
        uploadButton.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInput.click();
        });
        
        fileInput.addEventListener('change', () => handleFiles(fileInput.files));
        
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });
    }

    function handleFiles(files) {
        [...files].forEach(file => {
            const allFileNames = [...existingFiles.map(f => f.name), ...newFiles.map(f => f.name)];
            if (allFileNames.includes(file.name)) {
                showNotification(`Arquivo '${file.name}' já está na lista.`, 'warning');
            } else {
                newFiles.push(file);
            }
        });
        renderFileList();
        getInput('file-input').value = '';
    }

    function renderFileList() {
        const fileList = getInput('file-list');
        fileList.innerHTML = '';
        
        existingFiles.forEach(file => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `<span>${file.name}</span><button title="Remover">&times;</button>`;
            fileItem.querySelector('button').addEventListener('click', (e) => {
                e.stopPropagation();
                existingFiles = existingFiles.filter(f => f.name !== file.name);
                renderFileList();
            });
            fileList.appendChild(fileItem);
        });

        newFiles.forEach(file => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `<span>${file.name} (novo)</span><button title="Remover">&times;</button>`;
            fileItem.querySelector('button').addEventListener('click', (e) => {
                e.stopPropagation();
                newFiles = newFiles.filter(f => f.name !== file.name);
                renderFileList();
            });
            fileList.appendChild(fileItem);
        });
    }

    const resetarDados = async () => {
        if (confirm("TEM CERTEZA? Todos os dados de todas as seções serão apagados permanentemente.")) {
            try {
                showNotification("Excluindo dados... Por favor, aguarde.", "info");
                const collections = [ARQUIVO_FICHA_EPI, ARQUIVO_OBRA];
                const batch = writeBatch(db);
                
                for (const col of collections) {
                    const snapshot = await getDocs(query(collection(db, col)));
                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                }
                
                await batch.commit();

                showNotification("Todos os dados foram apagados.", 'warning');
                document.querySelectorAll('.cadastros-view').forEach(view => view.innerHTML = '<p style="text-align: center;">Nenhum item encontrado.</p>');
            } catch (error) {
                console.error("Erro ao resetar dados:", error);
                showNotification("Erro ao apagar os dados.", 'error');
            }
        }
    };
    
    const mostrarAlertas = () => {
        showNotification("Função de alertas ainda não implementada.", "info");
    }

    function toggleEpiData(checkbox) {
        const epiId = checkbox.id.replace('check-', '');
        const dataContainer = getInput(`data-${epiId}`);
        dataContainer.style.display = checkbox.checked ? 'block' : 'none';
    }

    function criarListaDeEPIs() {
        const lista = [
            'Capacete de segurança', 'Óculos de segurança', 'Protetor facial', 'Protetor auricular',
            'Máscara PFF2', 'Luvas de vaqueta', 'Luvas de borracha', 'Botas de segurança',
            'Perneiras', 'Cinto de segurança tipo paraquedista', 'Trava-quedas retrátil', 'Uniforme de trabalho'
        ];
        const container = getInput('epi-list-container');
        container.innerHTML = '';

        lista.forEach(nomeEpi => {
            const epiId = nomeEpi.replace(/\s+/g, '-').toLowerCase();
            const checkboxGroup = document.createElement('div');
            checkboxGroup.className = 'checkbox-group epi-selector';
            checkboxGroup.innerHTML = `<input type="checkbox" id="check-${epiId}" data-nome="${nomeEpi}"><label for="check-${epiId}">${nomeEpi}</label>`;
            
            const dataContainer = document.createElement('div');
            dataContainer.id = `data-${epiId}`;
            dataContainer.className = 'epi-data-container';
            dataContainer.style.display = 'none';
            dataContainer.innerHTML = `
                <div class="form-group"> <label for="entrega-${epiId}">Data de entrega</label> <input type="date" id="entrega-${epiId}"> </div>
                <div class="form-group"> <label for="tempo-${epiId}">Tempo de troca (dias)</label> <input type="number" id="tempo-${epiId}"> </div>
                <div class="form-group"> <label for="troca-${epiId}">Data da troca</label> <input type="date" id="troca-${epiId}"> </div>
                <div class="form-group"> <label for="justificativa-${epiId}">Justificativa</label> <textarea id="justificativa-${epiId}" rows="2"></textarea> </div>
            `;
            
            container.appendChild(checkboxGroup);
            container.appendChild(dataContainer);

            checkboxGroup.querySelector('input').addEventListener('change', (e) => toggleEpiData(e.target));
        });
    }

    window.salvarFichaEpi = salvarFichaEpi;
    window.toggleView = toggleView;
    window.atualizarVisualizacao = atualizarVisualizacao;
    window.salvarObra = salvarObra;
    window.marcarEnvioDocumentos = marcarEnvioDocumentos;
    window.carregarDetalhesDaObra = carregarDetalhesDaObra;
    window.showPage = showPage;
    window.fecharModalNotificacao = fecharModalNotificacao;
    window.abrirModalNotificacao = abrirModalNotificacao;
    window.editarItem = editarItem;
    window.excluirItem = excluirItem;
    window.resetarDados = resetarDados;
    window.mostrarAlertas = mostrarAlertas;

    window.onload = () => {
        if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-theme');
        getInput('btn-dark-mode-toggle').addEventListener('click', toggleDarkMode);
        
        const menuButton = getInput('menu-toggle-btn');
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.querySelector('.overlay');
        
        menuButton.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        });
        overlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        });

        getInput('notification-modal').addEventListener('click', (event) => {
            if (event.target === event.currentTarget) fecharModalNotificacao();
        });
        
        criarListaDeEPIs();
        setupFileUpload();
        showPage('fichas_epi');
    };
</script>

</body>
</html>